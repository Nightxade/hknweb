{% extends 'base.html' %}

{% block title %}Course Guide{% endblock %}

{% block header %}
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="//d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
    <style>
        .graph {
            display: block;
            text-align: center;
            margin: auto;
            background-color: ghostwhite;
        }
        /* .links line {
            stroke: #aaa;
        } */
        .nodes circle {
            pointer-events: all;
        }
        .group_selection {
            text-align: center;
            font-size: 125%;
        }
        .svg-container { /* Questionable display on phones possibly? */
            width: 100%;
            overflow: hidden;
        }
        
    </style>
    <script>
        function action(group) {
            const urlParams = new URLSearchParams(window.location.search);
            var groups = urlParams.get("groups") || "Core";
            groups = groups.split(",");
            const checkbox = document.getElementById(group);
            if (checkbox.checked) {
                groups.push(group);
            } else {
                const idx = groups.indexOf(group);
                if (idx > -1) groups.splice(idx, 1);
            }
            groups = groups.join();
            if (history.pushState) {
                const newurl = window.location.origin + window.location.pathname + "?groups=" + groups;
                window.history.replaceState({path: newurl}, "", newurl);
            }
            window.location = window.location;
        }
    </script>
{% endblock %}

{% block heading %}Course Guide{% endblock %}

{% block content %}
    <div class="group_selection">
        {% for group in groups %}
            <input type="checkbox"
                   id="{{ group }}"
                   {% if group in request.GET.groups %} checked {% endif %}
                   onclick="action('{{ group }}')"> {{ group }}
        {% endfor %}
    </div>

    <h2 style="text-align: center;">
        Get a description of each EECS Academic Area here:
        <a href="https://www2.eecs.berkeley.edu/Research/Areas/">EECS Research Areas</a>
    </h2>

    <h2 style="text-align: center;">
        <a href="/static/img/course-map-2019.png">Image version of the Course Guide</a>
    </h2>

    <div class="svg-container">
        <svg class="graph">
        </svg>
    </div>
    <button id="editButton" onclick="toggleEdit()"> Edit </button>

    <script>
        // Edit Code
        let isEditMode = false;
        function toggleEdit() {
            isEditMode = !isEditMode;
            const buttonElem = document.getElementById("editButton");
            if (isEditMode) {
                buttonElem.textContent = "Close Edit"
            }
            else {
                buttonElem.textContent = "Edit"
            }

        }


        const width = 1000;
        const height = 1000;
        const centerX = width / 2;
        const centerY = width / 2;
        const link_stroke_width = 5;
        const arrowhead_size = link_stroke_width*1.5;
        const circle_radius = 30;

        const svg = d3.select("svg")
            .attr("width", width)
            .attr("height", width)
            .attr("viewBox", [-width / 2, -height / 2, width, height]);
        
        


        async function grabData() {
            const data = await d3.json("{% url 'studentservices:course_guide_data' %}?groups={{ request.GET.groups }}")        
            console.log(data)
            return data
        }

        async function generate() {
            const graph = await grabData();
            const nodes = graph.nodes.map(d => ({ ...d }));
            const links = graph.links.map(d => ({ ...d }));
          
            const color = d3.scaleOrdinal(d3.schemeCategory10);
          
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).strength(0.05))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("overlap", d3.forceCollide())
                .force("x", d3.forceX())
                .force("y", d3.forceY())
                .force("radial", d3.forceRadial(d => d.level * 300).strength(0.7));
            
            svg.append("defs").append("marker")
                .attr("id", "arrow")
                .attr("viewBox", `0 0 ${arrowhead_size} ${arrowhead_size}`) // simplified
                .attr("refX", circle_radius + arrowhead_size * 0.6) // offset by radius + a bit
                .attr("refY", arrowhead_size / 2)
                .attr("markerWidth", arrowhead_size)
                .attr("markerHeight", arrowhead_size)
                .attr("orient", "auto")
                .append("path")
                .attr("d", `M0,0 L${arrowhead_size},${arrowhead_size / 2} L0,${arrowhead_size} Z`)
                .attr("fill", "#999");
            
            // Creates a group that holds everything in the svg (ie nodes, link, etc)
            const container = svg.append("g")

            // Creates the background displays
            const levels = [1, 2, 3, 4, 5, 6];
            const levels_background = container.append("g")
                .selectAll("circle")
                .data(levels)
                .enter()
                .append("circle")
                    .attr("r", d => d * 300)
                    .attr("stroke", "#000")
                    .attr("fill", "none");
            


            

            // Defines a zoom interaction that occurs on whatever elements calls it
            const zoom = d3.zoom()
                .scaleExtent([0.1, 5]) 
                .on("zoom", (event) => {
                    container.attr("transform", event.transform);
                });
            
            // Binds the defined zoom interaction to the entire svg element
            svg.call(zoom)

            // Creates the links that appear
            const link = container.append("g")
                .attr("stroke", "#aaa")
                .attr("stroke-opacity", 0.6)
                .selectAll("line")
                .data(links)
                .enter()
                .append("line")
                .attr("stroke-width", 1.5)
                .attr("marker-end", "url(#arrow)");
            
            // Creates the nodes that appear
            const node = container.append("g")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            node.append("circle")
                .attr("r", circle_radius)
                .attr("fill", d => color(d.group));
            
            node.append("a")
                .attr("xlink:href", d => d.link)
                .attr("target", "_blank")
            .append("text")
                .attr("text-anchor", "middle")
                .attr("alignment-baseline", "middle")
                .text(d => d.id)

            node.append("title")
                .text(d => d.id);
              
            simulation.on("tick", () => {
              link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
          
              node
                .attr("transform", d => `translate(${d.x},${d.y})`)
            });
          
            function dragstarted(event, d) {
              if (!event.active) simulation.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
            }
          
            function dragged(event, d) {
              d.fx = event.x;
              d.fy = event.y;
            }
          
            function dragended(event, d) {
              if (!event.active) simulation.alphaTarget(0);
              d.fx = null;
              d.fy = null;
            }

            
            return 
          }
        generate();
        
    </script>
     
{% endblock %}

